#!/usr/bin/env bash

DIFF=$(git diff --cached)
EDITED=false

if [ -z "$DIFF" ]; then
    echo "No changes to commit"
    exit 0;
fi

PROMPT=$(cat << EOF
Generate a Git commit message from the provided git diff that strictly follows the Conventional Commit specification and the conventions described below.

The commit message must follow this structure:
<type>(<optional scope>): <description>
<optional body>
<optional footer>

Choose the correct commit type based on the changes in the diff. Valid types are:
build - Changes to build system or external dependencies (e.g., Quarto extensions, etc.)
ci - Changes to continuous integration (“CI”) operations (e.g., GitHub Actions, etc.)
docs - Changes to documentation
feat - Changes that introduce a new feature
fix - Changes that fix a bug
perf - Changes that affect (improve) performance
refactor - Changes that neither fix a bug nor add a feature. Used when the output of the code is unchanged but the way in which that output is reached has changed
style - Changes that do not affect the meaning of the code (e.g., white space, formatting, etc.)
test - Changes that create or modify tests

Include a scope only if it adds meaningful context. Scopes are project-specific and must not contain issue identifiers.

The description is mandatory. It must be written in the imperative, present tense (for example: “add”, “fix”, “remove”). Do not capitalize the first letter and do not end the description with a period.

If the change introduces a breaking change, add "!" before the colon in the subject line and describe the breaking change in the footer. The footer must start with "BREAKING CHANGE:". Use a single line for short explanations or multiple lines if more detail is required.

The body is optional and should explain the motivation for the change or contrast previous behavior, using imperative present tense.

The footer is optional unless there is a breaking change. It may include issue references such as "Closes #123" or "Fixes JIRA-456".

Initial commits must use exactly:
chore: init

Merge commits and revert commits must follow Git’s default messages and should not be rewritten.

Do not invent changes that are not present in the diff. Do not mention tooling, rules, or analysis in the output. Output only the final commit message.

Here is the git diff to analyze:

$DIFF
EOF
)

generateCommitMsg() {
    RESPONSE=$(ollama run qwen3:8b-q4_K_M "$PROMPT" --keepalive 30s)
    COMMIT_MESSAGE=$(echo "$RESPONSE" | sed -n '/\.\.\.done thinking/,$p' | sed '1d' | sed '/./,$!d')
}

while true; do
    if [ "$EDITED" = false ]; then
        generateCommitMsg
    fi
    echo -e "\nProposed commit message:"
    echo "----------------------------------------"
    echo "$COMMIT_MESSAGE"
    echo "----------------------------------------"
    echo "How would you like to proceed?"
    read -rp "(C)ommit (E)dit (R)egenerate (D)iscard: " choice

    case "$choice" in
        c|C)
            git commit -m "$COMMIT_MESSAGE"
            break
            ;;
        e|E)
            EDITED=true
            TMPFILE=$(mktemp)
            echo "$COMMIT_MESSAGE" > "$TMPFILE"
            nvim "$TMPFILE"
            COMMIT_MESSAGE=$(cat "$TMPFILE")
            rm "$TMPFILE"
            ;;
        r|R)
            EDITED=false
            ;;
        d|D)
            exit
            break
            ;;
        *)
            echo "Invalid option."
            ;;
    esac
done
